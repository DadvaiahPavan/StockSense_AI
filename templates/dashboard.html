{% extends 'base.html' %}

{% block title %}Dashboard - StockSense AI{% endblock %}

{% block content %}
<!-- Add loading overlay -->
<div id="dashboardLoadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading market data...</div>
    <div class="loading-progress-container">
        <div class="loading-progress"></div>
    </div>
</div>

<div class="dashboard-container">
    <!-- Market Overview Section -->
    <section class="market-overview py-4">
        <div class="container">
            <div class="row mb-4">
                <div class="col">
                    <h2 class="fw-bold mb-0">Market Overview</h2>
                    <p class="text-muted">Live market indices and trends</p>
                </div>
                <div class="col-auto">
                    <span class="badge bg-success">
                        <i class="fas fa-clock me-1"></i> Live Data
                    </span>
                </div>
            </div>
            
            <div class="row g-3">
                {% for symbol, data in indices.items() %}
                <div class="col-md-4 col-lg">
                    <div class="card border-0 shadow-sm h-100 index-card">
                        <div class="card-body">
                            <h5 class="card-title">{{ data.name }}</h5>
                            <h3 class="mb-0 fw-bold">{{ data.price }}</h3>
                            <div class="d-flex align-items-center mt-2">
                                <span class="me-2 {% if data.change > 0 %}text-success{% else %}text-danger{% endif %}">
                                    <i class="fas {% if data.change > 0 %}fa-caret-up{% else %}fa-caret-down{% endif %}"></i>
                                    {{ data.change }}
                                </span>
                                <span class="badge {% if data.change > 0 %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ data.change_percent }}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    
    <!-- Main Dashboard Content -->
    <section class="dashboard-content py-4">
        <div class="container">
            <div class="row g-4">
                <!-- Watchlist -->
                <div class="col-lg-8">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold">Your Watchlist</h5>
                            <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#stockSearchModal">
                                <i class="fas fa-plus me-1"></i> Add Stock
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Symbol</th>
                                            <th>Name</th>
                                            <th>Price</th>
                                            <th>Change</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% if watchlist %}
                                            {% for stock in watchlist %}
                                            <tr>
                                                <td>
                                                    <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="fw-bold text-decoration-none">
                                                        {{ stock.symbol }}
                                                    </a>
                                                </td>
                                                <td>{{ stock.name }}</td>
                                                <td class="fw-bold">${{ stock.price }}</td>
                                                <td>
                                                    <span class="{% if stock.change > 0 %}text-success{% else %}text-danger{% endif %}">
                                                        <i class="fas {% if stock.change > 0 %}fa-caret-up{% else %}fa-caret-down{% endif %}"></i>
                                                        {{ stock.change }} {% if stock.change_percent is defined %}({{ stock.change_percent }}%){% endif %}
                                                    </span>
                                                </td>
                                                <td>
                                                    <div class="btn-group">
                                                        <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-chart-line"></i>
                                                        </a>
                                                        <a href="{{ url_for('stock_analysis', symbol=stock.symbol) }}" class="btn btn-sm btn-outline-info">
                                                            <i class="fas fa-brain"></i>
                                                        </a>
                                                        <button class="btn btn-sm btn-outline-danger remove-from-watchlist" data-symbol="{{ stock.symbol }}" type="button">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        {% else %}
                                            <tr>
                                                <td colspan="5" class="text-center py-4">
                                                    <div class="empty-state">
                                                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                                        <h5>Your watchlist is empty</h5>
                                                        <p class="text-muted">Add stocks to your watchlist to track them here</p>
                                                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#stockSearchModal">
                                                            <i class="fas fa-plus me-1"></i> Add Stock
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endif %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Market News -->
                <div class="col-lg-4">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 fw-bold">Latest Market News</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush">
                                {% for item in news %}
                                <a href="{{ item.url }}" target="_blank" class="list-group-item list-group-item-action">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">{{ item.title }}</h6>
                                            <div class="d-flex align-items-center text-muted small">
                                                <span class="me-2">{{ item.source }}</span>
                                                <span>{{ item.published }}</span>
                                            </div>
                                        </div>
                                        <span class="ms-2 news-arrow">
                                            <i class="fas fa-chevron-right"></i>
                                        </span>
                                    </div>
                                </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Stock Market Data -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 fw-bold">Stocks</h5>
                            <ul class="nav nav-tabs card-header-tabs mt-2" id="stockTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="most-active-tab" data-bs-toggle="tab" data-bs-target="#most-active" type="button" role="tab" aria-controls="most-active" aria-selected="true">Most Active</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="trending-tab" data-bs-toggle="tab" data-bs-target="#trending" type="button" role="tab" aria-controls="trending" aria-selected="false">Trending Now</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="gainers-tab" data-bs-toggle="tab" data-bs-target="#gainers" type="button" role="tab" aria-controls="gainers" aria-selected="false">Top Gainers</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="losers-tab" data-bs-toggle="tab" data-bs-target="#losers" type="button" role="tab" aria-controls="losers" aria-selected="false">Top Losers</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="52-week-gainers-tab" data-bs-toggle="tab" data-bs-target="#52-week-gainers" type="button" role="tab" aria-controls="52-week-gainers" aria-selected="false">52 Week Gainers</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="52-week-losers-tab" data-bs-toggle="tab" data-bs-target="#52-week-losers" type="button" role="tab" aria-controls="52-week-losers" aria-selected="false">52 Week Losers</button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body p-0">
                            <div class="tab-content" id="stockTabsContent">
                                <!-- Most Active Stocks -->
                                <div class="tab-pane fade show active" id="most-active" role="tabpanel" aria-labelledby="most-active-tab">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Name</th>
                                                    <th>Price</th>
                                                    <th>Change</th>
                                                    <th>Change %</th>
                                                    <th>Volume</th>
                                                    <th>Avg Vol</th>
                                                    <th>Market Cap</th>
                                                    <th>PE Ratio</th>
                                                    <th>52 Wk Change %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if most_active and not most_active.error %}
                                                    {% for stock in most_active %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="fw-bold text-decoration-none">
                                                                {{ stock.symbol }}
                                                            </a>
                                                        </td>
                                                        <td>{{ stock.name }}</td>
                                                        <td class="fw-bold">${{ stock.price }}</td>
                                                        <td class="{% if stock.change > 0 %}text-success{% elif stock.change < 0 %}text-danger{% endif %}">
                                                            {% if stock.change > 0 %}+{% endif %}{{ stock.change }}
                                                        </td>
                                                        <td class="{% if stock.change_percent > 0 %}text-success{% elif stock.change_percent < 0 %}text-danger{% endif %}">
                                                            <span>
                                                                <i class="fas {% if stock.change_percent > 0 %}fa-caret-up{% elif stock.change_percent < 0 %}fa-caret-down{% endif %}"></i>
                                                                {% if stock.change_percent > 0 %}+{% endif %}{{ stock.change_percent }}%
                                                            </span>
                                                        </td>
                                                        <td>{{ stock.volume }}</td>
                                                        <td>{{ stock.avg_volume if stock.avg_volume is defined else 'N/A' }}</td>
                                                        <td>{{ stock.market_cap if stock.market_cap is defined else 'N/A' }}</td>
                                                        <td>{{ stock.pe_ratio if stock.pe_ratio is defined else 'N/A' }}</td>
                                                        <td class="{% if stock.week52_change > 0 %}text-success{% elif stock.week52_change < 0 %}text-danger{% endif %}">
                                                            {% if stock.week52_change != 'N/A' %}
                                                                {% if stock.week52_change > 0 %}+{% endif %}{{ stock.week52_change }}%
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="10" class="text-center py-4">
                                                            <div class="empty-state">
                                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                                <h5>No data available</h5>
                                                                <p class="text-muted">Unable to fetch most active stocks data</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Trending Stocks -->
                                <div class="tab-pane fade" id="trending" role="tabpanel" aria-labelledby="trending-tab">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Name</th>
                                                    <th>Price</th>
                                                    <th>Change</th>
                                                    <th>Change %</th>
                                                    <th>Volume</th>
                                                    <th>Avg Vol</th>
                                                    <th>Market Cap</th>
                                                    <th>PE Ratio</th>
                                                    <th>52 Wk Change %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if trending and not trending.error %}
                                                    {% for stock in trending %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="fw-bold text-decoration-none">
                                                                {{ stock.symbol }}
                                                            </a>
                                                        </td>
                                                        <td>{{ stock.name }}</td>
                                                        <td class="fw-bold">${{ stock.price }}</td>
                                                        <td class="{% if stock.change > 0 %}text-success{% elif stock.change < 0 %}text-danger{% endif %}">
                                                            {% if stock.change > 0 %}+{% endif %}{{ stock.change }}
                                                        </td>
                                                        <td class="{% if stock.change_percent > 0 %}text-success{% elif stock.change_percent < 0 %}text-danger{% endif %}">
                                                            <span>
                                                                <i class="fas {% if stock.change_percent > 0 %}fa-caret-up{% elif stock.change_percent < 0 %}fa-caret-down{% endif %}"></i>
                                                                {% if stock.change_percent > 0 %}+{% endif %}{{ stock.change_percent }}%
                                                            </span>
                                                        </td>
                                                        <td>{{ stock.volume }}</td>
                                                        <td>{{ stock.avg_volume if stock.avg_volume is defined else 'N/A' }}</td>
                                                        <td>{{ stock.market_cap if stock.market_cap is defined else 'N/A' }}</td>
                                                        <td>{{ stock.pe_ratio if stock.pe_ratio is defined else 'N/A' }}</td>
                                                        <td class="{% if stock.week52_change > 0 %}text-success{% elif stock.week52_change < 0 %}text-danger{% endif %}">
                                                            {% if stock.week52_change != 'N/A' %}
                                                                {% if stock.week52_change > 0 %}+{% endif %}{{ stock.week52_change }}%
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="10" class="text-center py-4">
                                                            <div class="empty-state">
                                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                                <h5>No data available</h5>
                                                                <p class="text-muted">Unable to fetch trending stocks data</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Top Gainers -->
                                <div class="tab-pane fade" id="gainers" role="tabpanel" aria-labelledby="gainers-tab">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Name</th>
                                                    <th>Price</th>
                                                    <th>Change</th>
                                                    <th>Change %</th>
                                                    <th>Volume</th>
                                                    <th>Avg Vol</th>
                                                    <th>Market Cap</th>
                                                    <th>PE Ratio</th>
                                                    <th>52 Wk Change %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if gainers and not gainers.error %}
                                                    {% for stock in gainers %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="fw-bold text-decoration-none">
                                                                {{ stock.symbol }}
                                                            </a>
                                                        </td>
                                                        <td>{{ stock.name }}</td>
                                                        <td class="fw-bold">${{ stock.price }}</td>
                                                        <td class="{% if stock.change > 0 %}text-success{% elif stock.change < 0 %}text-danger{% endif %}">
                                                            {% if stock.change > 0 %}+{% endif %}{{ stock.change }}
                                                        </td>
                                                        <td class="{% if stock.change_percent > 0 %}text-success{% elif stock.change_percent < 0 %}text-danger{% endif %}">
                                                            <span>
                                                                <i class="fas {% if stock.change_percent > 0 %}fa-caret-up{% elif stock.change_percent < 0 %}fa-caret-down{% endif %}"></i>
                                                                {% if stock.change_percent > 0 %}+{% endif %}{{ stock.change_percent }}%
                                                            </span>
                                                        </td>
                                                        <td>{{ stock.volume }}</td>
                                                        <td>{{ stock.avg_volume if stock.avg_volume is defined else 'N/A' }}</td>
                                                        <td>{{ stock.market_cap if stock.market_cap is defined else 'N/A' }}</td>
                                                        <td>{{ stock.pe_ratio if stock.pe_ratio is defined else 'N/A' }}</td>
                                                        <td class="{% if stock.week52_change > 0 %}text-success{% elif stock.week52_change < 0 %}text-danger{% endif %}">
                                                            {% if stock.week52_change != 'N/A' %}
                                                                {% if stock.week52_change > 0 %}+{% endif %}{{ stock.week52_change }}%
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="10" class="text-center py-4">
                                                            <div class="empty-state">
                                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                                <h5>No data available</h5>
                                                                <p class="text-muted">Unable to fetch top gainers data</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Top Losers -->
                                <div class="tab-pane fade" id="losers" role="tabpanel" aria-labelledby="losers-tab">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Name</th>
                                                    <th>Price</th>
                                                    <th>Change</th>
                                                    <th>Change %</th>
                                                    <th>Volume</th>
                                                    <th>Avg Vol</th>
                                                    <th>Market Cap</th>
                                                    <th>PE Ratio</th>
                                                    <th>52 Wk Change %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if losers and not losers.error %}
                                                    {% for stock in losers %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="fw-bold text-decoration-none">
                                                                {{ stock.symbol }}
                                                            </a>
                                                        </td>
                                                        <td>{{ stock.name }}</td>
                                                        <td class="fw-bold">${{ stock.price }}</td>
                                                        <td class="{% if stock.change > 0 %}text-success{% elif stock.change < 0 %}text-danger{% endif %}">
                                                            {% if stock.change > 0 %}+{% endif %}{{ stock.change }}
                                                        </td>
                                                        <td class="{% if stock.change_percent > 0 %}text-success{% elif stock.change_percent < 0 %}text-danger{% endif %}">
                                                            <span>
                                                                <i class="fas {% if stock.change_percent > 0 %}fa-caret-up{% elif stock.change_percent < 0 %}fa-caret-down{% endif %}"></i>
                                                                {% if stock.change_percent > 0 %}+{% endif %}{{ stock.change_percent }}%
                                                            </span>
                                                        </td>
                                                        <td>{{ stock.volume }}</td>
                                                        <td>{{ stock.avg_volume if stock.avg_volume is defined else 'N/A' }}</td>
                                                        <td>{{ stock.market_cap if stock.market_cap is defined else 'N/A' }}</td>
                                                        <td>{{ stock.pe_ratio if stock.pe_ratio is defined else 'N/A' }}</td>
                                                        <td class="{% if stock.week52_change > 0 %}text-success{% elif stock.week52_change < 0 %}text-danger{% endif %}">
                                                            {% if stock.week52_change != 'N/A' %}
                                                                {% if stock.week52_change > 0 %}+{% endif %}{{ stock.week52_change }}%
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="10" class="text-center py-4">
                                                            <div class="empty-state">
                                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                                <h5>No data available</h5>
                                                                <p class="text-muted">Unable to fetch top losers data</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- 52 Week Gainers -->
                                <div class="tab-pane fade" id="52-week-gainers" role="tabpanel" aria-labelledby="52-week-gainers-tab">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Name</th>
                                                    <th>Price</th>
                                                    <th>Change</th>
                                                    <th>Change %</th>
                                                    <th>Volume</th>
                                                    <th>Avg Vol</th>
                                                    <th>Market Cap</th>
                                                    <th>PE Ratio</th>
                                                    <th>52 Wk Change %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if week52_gainers and not week52_gainers.error %}
                                                    {% for stock in week52_gainers %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="fw-bold text-decoration-none">
                                                                {{ stock.symbol }}
                                                            </a>
                                                        </td>
                                                        <td>{{ stock.name }}</td>
                                                        <td class="fw-bold">${{ stock.price }}</td>
                                                        <td class="{% if stock.change > 0 %}text-success{% elif stock.change < 0 %}text-danger{% endif %}">
                                                            {% if stock.change > 0 %}+{% endif %}{{ stock.change }}
                                                        </td>
                                                        <td class="{% if stock.change_percent > 0 %}text-success{% elif stock.change_percent < 0 %}text-danger{% endif %}">
                                                            <span>
                                                                <i class="fas {% if stock.change_percent > 0 %}fa-caret-up{% elif stock.change_percent < 0 %}fa-caret-down{% endif %}"></i>
                                                                {% if stock.change_percent > 0 %}+{% endif %}{{ stock.change_percent }}%
                                                            </span>
                                                        </td>
                                                        <td>{{ stock.volume }}</td>
                                                        <td>{{ stock.avg_volume if stock.avg_volume is defined else 'N/A' }}</td>
                                                        <td>{{ stock.market_cap if stock.market_cap is defined else 'N/A' }}</td>
                                                        <td>{{ stock.pe_ratio if stock.pe_ratio is defined else 'N/A' }}</td>
                                                        <td class="{% if stock.week52_change > 0 %}text-success{% elif stock.week52_change < 0 %}text-danger{% endif %}">
                                                            {% if stock.week52_change != 'N/A' %}
                                                                {% if stock.week52_change > 0 %}+{% endif %}{{ stock.week52_change }}%
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="10" class="text-center py-4">
                                                            <div class="empty-state">
                                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                                <h5>No data available</h5>
                                                                <p class="text-muted">Unable to fetch 52 week gainers data</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- 52 Week Losers -->
                                <div class="tab-pane fade" id="52-week-losers" role="tabpanel" aria-labelledby="52-week-losers-tab">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Symbol</th>
                                                    <th>Name</th>
                                                    <th>Price</th>
                                                    <th>Change</th>
                                                    <th>Change %</th>
                                                    <th>Volume</th>
                                                    <th>Avg Vol</th>
                                                    <th>Market Cap</th>
                                                    <th>PE Ratio</th>
                                                    <th>52 Wk Change %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% if week52_losers and not week52_losers.error %}
                                                    {% for stock in week52_losers %}
                                                    <tr>
                                                        <td>
                                                            <a href="{{ url_for('stock_details', symbol=stock.symbol) }}" class="fw-bold text-decoration-none">
                                                                {{ stock.symbol }}
                                                            </a>
                                                        </td>
                                                        <td>{{ stock.name }}</td>
                                                        <td class="fw-bold">${{ stock.price }}</td>
                                                        <td class="{% if stock.change > 0 %}text-success{% elif stock.change < 0 %}text-danger{% endif %}">
                                                            {% if stock.change > 0 %}+{% endif %}{{ stock.change }}
                                                        </td>
                                                        <td class="{% if stock.change_percent > 0 %}text-success{% elif stock.change_percent < 0 %}text-danger{% endif %}">
                                                            <span>
                                                                <i class="fas {% if stock.change_percent > 0 %}fa-caret-up{% elif stock.change_percent < 0 %}fa-caret-down{% endif %}"></i>
                                                                {% if stock.change_percent > 0 %}+{% endif %}{{ stock.change_percent }}%
                                                            </span>
                                                        </td>
                                                        <td>{{ stock.volume }}</td>
                                                        <td>{{ stock.avg_volume if stock.avg_volume is defined else 'N/A' }}</td>
                                                        <td>{{ stock.market_cap if stock.market_cap is defined else 'N/A' }}</td>
                                                        <td>{{ stock.pe_ratio if stock.pe_ratio is defined else 'N/A' }}</td>
                                                        <td class="{% if stock.week52_change > 0 %}text-success{% elif stock.week52_change < 0 %}text-danger{% endif %}">
                                                            {% if stock.week52_change != 'N/A' %}
                                                                {% if stock.week52_change > 0 %}+{% endif %}{{ stock.week52_change }}%
                                                            {% else %}
                                                                N/A
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                {% else %}
                                                    <tr>
                                                        <td colspan="10" class="text-center py-4">
                                                            <div class="empty-state">
                                                                <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                                                                <h5>No data available</h5>
                                                                <p class="text-muted">Unable to fetch 52 week losers data</p>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Insights -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white">
                            <h5 class="mb-0 fw-bold">
                                <i class="fas fa-robot me-2 text-primary"></i> AI Market Insights
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="ai-insight-container">
                                <div class="ai-insight-message">
                                    <p class="mb-2">Based on current market conditions and your portfolio, here are some insights:</p>
                                    <ul class="mb-0">
                                        <li>Technology sector is showing strong momentum with positive earnings surprises</li>
                                        <li>Recent volatility in financial stocks suggests caution in this sector</li>
                                        <li>Consider diversifying into healthcare stocks for defensive positioning</li>
                                        <li>Watch for upcoming Fed announcements that may impact interest rate sensitive stocks</li>
                                    </ul>
                                </div>
                                <div class="mt-3">
                                    <a href="{{ url_for('chatbot') }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-comment-dots me-1"></i> Ask AI Assistant
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        background-color: #f8f9fa;
        min-height: calc(100vh - 56px - 174px); /* Subtract navbar and footer height */
    }
    
    .index-card {
        transition: transform 0.3s ease;
        border-radius: 10px;
        overflow: hidden;
    }
    
    .index-card:hover {
        transform: translateY(-5px);
    }
    
    .card {
        border-radius: 10px;
        overflow: hidden;
    }
    
    .card-header {
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    
    .empty-state {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }
    
    .news-arrow {
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    .list-group-item:hover .news-arrow {
        opacity: 1;
        transform: translateX(5px);
    }
    
    .ai-insight-container {
        position: relative;
    }
    
    .ai-insight-message {
        background-color: #f8f9ff;
        border-left: 4px solid #4e73df;
        padding: 1rem;
        border-radius: 0 10px 10px 0;
    }
    
    .time-range-btn {
        transition: all 0.2s ease;
    }
    
    .time-range-btn.active {
        background-color: var(--bs-primary);
        color: white;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Show loading overlay when page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Display loading overlay
        const loadingOverlay = document.getElementById('dashboardLoadingOverlay');
        loadingOverlay.style.display = 'flex';
        
        // Simulate progress
        const progressBar = document.querySelector('.loading-progress');
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            progressBar.style.width = `${progress}%`;
            
            if (progress >= 100) {
                clearInterval(progressInterval);
                // Hide loading overlay after a short delay
                setTimeout(() => {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }, 500);
            }
        }, 100);
        
        // Setup watchlist remove buttons
        setupWatchlistRemoveButtons();
        
        // Setup tabs
        const tabLinks = document.querySelectorAll('#stockTabs .nav-link');
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Remove active class from all tabs
                tabLinks.forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Add active class to clicked tab
                this.classList.add('active');
                
                // Show corresponding tab content
                const tabId = this.getAttribute('href').substring(1);
                const tabContents = document.querySelectorAll('#stockTabsContent .tab-pane');
                tabContents.forEach(content => {
                    content.classList.remove('show', 'active');
                });
                document.getElementById(tabId).classList.add('show', 'active');
            });
        });
        
        // Initialize all tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    
    // Stock search functionality
    const stockSearchLink = document.getElementById('stockSearchLink');
    const stockSearchInput = document.getElementById('stockSearchInput');
    const stockSearchResults = document.getElementById('stockSearchResults');
    
    stockSearchLink.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById('stockSearchModal'));
        modal.show();
    });
    
    stockSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        
        if (query.length < 2) {
            stockSearchResults.innerHTML = '';
            return;
        }
        
        // Fetch stock search results
        fetch(`/api/stock/search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                stockSearchResults.innerHTML = '';
                
                data.forEach(stock => {
                    const item = document.createElement('a');
                    item.href = '#';
                    item.className = 'list-group-item list-group-item-action';
                    item.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${stock.symbol}</strong>
                                <div class="text-muted small">${stock.name}</div>
                            </div>
                            <button class="btn btn-sm btn-outline-primary add-to-watchlist" 
                                    data-symbol="${stock.symbol}" 
                                    data-name="${stock.name}">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    `;
                    
                    stockSearchResults.appendChild(item);
                });
                
                // Add event listeners to the "Add to Watchlist" buttons
                document.querySelectorAll('.add-to-watchlist').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        const symbol = this.dataset.symbol;
                        const name = this.dataset.name;
                        
                        // Add to watchlist via API
                        fetch('/api/watchlist/add', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                symbol: symbol,
                                name: name
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Close modal and refresh page
                                const modal = bootstrap.Modal.getInstance(document.getElementById('stockSearchModal'));
                                modal.hide();
                                window.location.reload();
                            }
                        });
                    });
                });
            });
    });
    
    // Function to setup watchlist remove buttons
    function setupWatchlistRemoveButtons() {
        document.querySelectorAll('.remove-from-watchlist').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                const symbol = this.dataset.symbol;
                const stockRow = this.closest('tr');
                
                if (confirm(`Remove ${symbol} from your watchlist?`)) {
                    // Show loading state
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    this.disabled = true;
                    
                    // Remove from watchlist via API
                    fetch('/api/watchlist/remove', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        body: JSON.stringify({
                            symbol: symbol
                        })
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            // Remove the row from the table with animation
                            stockRow.style.transition = 'opacity 0.5s ease';
                            stockRow.style.opacity = '0';
                            setTimeout(() => {
                                stockRow.remove();
                                
                                // Check if watchlist is empty and show empty state if needed
                                const watchlistTable = document.querySelector('table tbody');
                                if (watchlistTable && watchlistTable.querySelectorAll('tr').length === 0) {
                                    const emptyRow = document.createElement('tr');
                                    emptyRow.innerHTML = `
                                        <td colspan="5" class="text-center py-4">
                                            <div class="empty-state">
                                                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                                <h5>Your watchlist is empty</h5>
                                                <p class="text-muted">Add stocks to your watchlist to track them here</p>
                                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#stockSearchModal">
                                                    <i class="fas fa-plus me-1"></i> Add Stock
                                                </button>
                                            </div>
                                        </td>
                                    `;
                                    watchlistTable.appendChild(emptyRow);
                                }
                            }, 500);
                        } else {
                            // Reset button state
                            this.innerHTML = '<i class="fas fa-trash"></i>';
                            this.disabled = false;
                            
                            // Show error message
                            alert(`Error removing ${symbol}: ${data.error || 'Unknown error'}`);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        
                        // Reset button state
                        this.innerHTML = '<i class="fas fa-trash"></i>';
                        this.disabled = false;
                        
                        // Show error message
                        alert(`Error removing ${symbol} from watchlist. Please try again.`);
                    });
                }
            });
        });
    }
    
    // Stock analysis link functionality
    const stockAnalysisLink = document.getElementById('stockAnalysisLink');
    stockAnalysisLink.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById('stockSearchModal'));
        modal.show();
        
        // Update modal title
        document.querySelector('#stockSearchModal .modal-title').textContent = 'Select Stock for Analysis';
        
        // Update event listeners for search results
        const originalSearchHandler = stockSearchInput.oninput;
        stockSearchInput.oninput = function() {
            const query = this.value.trim();
            
            if (query.length < 2) {
                stockSearchResults.innerHTML = '';
                return;
            }
            
            // Fetch stock search results
            fetch(`/api/stock/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    stockSearchResults.innerHTML = '';
                    
                    data.forEach(stock => {
                        const item = document.createElement('a');
                        item.href = `/stock-analysis/${stock.symbol}`;
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${stock.symbol}</strong>
                                    <div class="text-muted small">${stock.name}</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        `;
                        
                        stockSearchResults.appendChild(item);
                    });
                });
        };
        
        // Restore original handler when modal is closed
        document.getElementById('stockSearchModal').addEventListener('hidden.bs.modal', function() {
            document.querySelector('#stockSearchModal .modal-title').textContent = 'Search Stocks';
            stockSearchInput.oninput = originalSearchHandler;
        }, { once: true });
    });
    
    // Investment thesis link functionality
    const thesisLink = document.getElementById('thesisLink');
    thesisLink.addEventListener('click', function(e) {
        e.preventDefault();
        const modal = new bootstrap.Modal(document.getElementById('stockSearchModal'));
        modal.show();
        
        // Update modal title
        document.querySelector('#stockSearchModal .modal-title').textContent = 'Select Stock for Stock Predictor';
        
        // Update event listeners for search results
        const originalSearchHandler = stockSearchInput.oninput;
        stockSearchInput.oninput = function() {
            const query = this.value.trim();
            
            if (query.length < 2) {
                stockSearchResults.innerHTML = '';
                return;
            }
            
            // Fetch stock search results
            fetch(`/api/stock/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    stockSearchResults.innerHTML = '';
                    
                    data.forEach(stock => {
                        const item = document.createElement('a');
                        item.href = `/stock-predictor?symbol=${stock.symbol}`;
                        item.className = 'list-group-item list-group-item-action';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${stock.symbol}</strong>
                                    <div class="text-muted small">${stock.name}</div>
                                </div>
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        `;
                        
                        stockSearchResults.appendChild(item);
                    });
                });
        };
        
        // Restore original handler when modal is closed
        document.getElementById('stockSearchModal').addEventListener('hidden.bs.modal', function() {
            document.querySelector('#stockSearchModal .modal-title').textContent = 'Search Stocks';
            stockSearchInput.oninput = originalSearchHandler;
        }, { once: true });
    });
</script>
{% endblock %}
