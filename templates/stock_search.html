{% extends 'base.html' %}

{% block title %}Stock Search - StockSense AI{% endblock %}

{% block content %}
<!-- Stock Search Loading Animation Overlay -->
<div id="stockLoadingOverlay" class="stock-loading-overlay" style="display: none;">
    <div class="stock-loading-container">
        <div class="stock-loading-logo">
            <i class="fas fa-chart-line"></i>
        </div>
        <div class="stock-loading-graph">
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
            <div class="stock-bar"></div>
        </div>
        <div class="stock-loading-text">Loading Stock Data...</div>
        <div class="stock-loading-progress"></div>
    </div>
</div>

<div class="container py-5">
    <!-- Hero Section -->
    <div class="row mb-5" data-aos="fade-up">
        <div class="col-lg-12 text-center">
            <h1 class="display-4 fw-bold text-primary mb-3">Intelligent Stock Search</h1>
            <p class="lead text-muted mb-4">Discover real-time data, comprehensive analysis, and insights for stocks across US and Indian markets</p>
            <div class="d-flex justify-content-center">
                <div class="badge bg-light text-dark me-2 px-3 py-2"><i class="fas fa-bolt text-warning me-1"></i> Real-time Data</div>
                <div class="badge bg-light text-dark me-2 px-3 py-2"><i class="fas fa-chart-line text-success me-1"></i> Interactive Charts</div>
                <div class="badge bg-light text-dark px-3 py-2"><i class="fas fa-brain text-primary me-1"></i> AI Analysis</div>
            </div>
        </div>
    </div>
    
    <!-- Search Section -->
    <div class="row justify-content-center">
        <div class="col-lg-10 mb-5" data-aos="fade-up" data-aos-delay="100">
            <div class="modern-card shadow-lg border-0">
                <div class="card-body p-4 p-md-5">
                    <div class="search-container position-relative">
                        <div class="input-group-modern mb-4">
                            <span class="input-group-text bg-primary text-white">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="stockSearchInput" class="form-control-modern form-control-lg" 
                                   placeholder="Enter stock symbol or company name (e.g., AAPL, TSLA, RELIANCE.NS)">
                            <button class="btn btn-modern-primary btn-lg" type="button" id="stockSearchButton">
                                <i class="fas fa-search me-1"></i> Search
                            </button>
                        </div>
                        
                        <div class="search-examples text-center mb-4">
                            <span class="text-muted">Try popular stocks: </span>
                            <a href="#" class="badge rounded-pill bg-light text-primary me-1 stock-example" data-symbol="AAPL">AAPL</a>
                            <a href="#" class="badge rounded-pill bg-light text-primary me-1 stock-example" data-symbol="MSFT">MSFT</a>
                            <a href="#" class="badge rounded-pill bg-light text-primary me-1 stock-example" data-symbol="GOOGL">GOOGL</a>
                            <a href="#" class="badge rounded-pill bg-light text-primary me-1 stock-example" data-symbol="AMZN">AMZN</a>
                            <a href="#" class="badge rounded-pill bg-light text-primary me-1 stock-example" data-symbol="TSLA">TSLA</a>
                            <a href="#" class="badge rounded-pill bg-light text-primary me-1 stock-example" data-symbol="RELIANCE.NS">RELIANCE.NS</a>
                            <a href="#" class="badge rounded-pill bg-light text-primary stock-example" data-symbol="TCS.NS">TCS.NS</a>
                        </div>
                        
                        <div id="searchSuggestions" class="list-group rounded-md shadow-sm mb-4 position-absolute w-100 z-index-dropdown"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="stockResultsContainer" class="d-none">
        <!-- Stock Overview Card -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-10" data-aos="fade-up">
                <div class="modern-card border-0 shadow-lg overflow-hidden">
                    <div class="card-header bg-gradient-primary text-white p-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center">
                                <div class="stock-logo me-3 rounded-circle bg-white p-2 d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-chart-line fa-lg text-primary"></i>
                                </div>
                                <div>
                                    <h2 class="mb-0 fw-bold" id="stockName"></h2>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-white text-primary me-2" id="stockSymbol"></span>
                                        <span class="text-white-50" id="stockExchange"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <h2 class="mb-0 fw-bold" id="stockPrice"></h2>
                                <div id="stockChange"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="row g-4 mb-4">
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-chart-pie text-primary me-2"></i>
                                                <div class="text-muted small">Market Cap</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="marketCap"></div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-calculator text-secondary me-2"></i>
                                                <div class="text-muted small">P/E Ratio</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="peRatio"></div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-dollar-sign text-success me-2"></i>
                                                <div class="text-muted small">EPS</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="eps"></div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-hand-holding-usd text-warning me-2"></i>
                                                <div class="text-muted small">Dividend</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="dividendYield"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-4">
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-arrow-up text-success me-2"></i>
                                                <div class="text-muted small">52W High</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="high52Week"></div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-arrow-down text-danger me-2"></i>
                                                <div class="text-muted small">52W Low</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="low52Week"></div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-exchange-alt text-info me-2"></i>
                                                <div class="text-muted small">Volume</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="volume"></div>
                                        </div>
                                    </div>
                                    <div class="col-6 col-md-3">
                                        <div class="stock-stat p-3 rounded-md bg-light-medium">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="fas fa-chart-bar text-primary me-2"></i>
                                                <div class="text-muted small">Avg Volume</div>
                                            </div>
                                            <div class="fw-bold fs-5" id="avgVolume"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mt-4 mt-md-0 d-flex flex-column justify-content-center">
                                <div class="d-grid gap-3">
                                    <button class="btn btn-modern-primary btn-lg" id="addToWatchlistBtn">
                                        <i class="fas fa-plus me-2"></i> Add to Watchlist
                                    </button>
                                    <a href="#" class="btn btn-modern-secondary btn-lg" id="analysisLink">
                                        <i class="fas fa-brain me-2"></i> AI Analysis
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stock Chart Card -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-10" data-aos="fade-up" data-aos-delay="100">
                <div class="modern-card border-0 shadow-lg">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h3 class="mb-0 fw-bold text-primary"><i class="fas fa-chart-line me-2"></i>Price History</h3>
                            
                            <div class="chart-type-selector">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-modern-outline active" data-chart-type="line">
                                        <i class="fas fa-chart-line me-1"></i> Line
                                    </button>
                                    <button type="button" class="btn btn-modern-outline" data-chart-type="candlestick">
                                        <i class="fas fa-chart-bar me-1"></i> Candlestick
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-controls mb-4 d-flex justify-content-center">
                            <div class="time-period-selector">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-modern-primary active" data-period="1d">1D</button>
                                    <button type="button" class="btn btn-modern-primary" data-period="5d">5D</button>
                                    <button type="button" class="btn btn-modern-primary" data-period="1mo">1M</button>
                                    <button type="button" class="btn btn-modern-primary" data-period="3mo">3M</button>
                                    <button type="button" class="btn btn-modern-primary" data-period="6mo">6M</button>
                                    <button type="button" class="btn btn-modern-primary" data-period="1y">1Y</button>
                                    <button type="button" class="btn btn-modern-primary" data-period="5y">5Y</button>
                                    <button type="button" class="btn btn-modern-primary" data-period="max">Max</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container position-relative" style="height: 450px;">
                            <canvas id="stockChart" class="rounded-lg"></canvas>
                            
                            <!-- Chart Loading -->
                            <div id="chartLoading" class="chart-loading d-none">
                                <div class="loader-modern loader-sm">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                                <p class="mt-3 text-primary">Loading chart data...</p>
                            </div>
                            
                            <!-- Chart Error -->
                            <div id="chartError" class="chart-error d-none">
                                <div class="error-icon mb-3 rounded-circle bg-light d-flex align-items-center justify-content-center mx-auto" style="width: 80px; height: 80px;">
                                    <i class="fas fa-exclamation-triangle text-warning fa-2x"></i>
                                </div>
                                <h5 class="fw-bold">Unable to load chart data</h5>
                                <p class="text-muted mb-4">We couldn't retrieve the historical data for this stock.</p>
                                <button class="btn btn-modern-primary" id="retryChartBtn">
                                    <i class="fas fa-sync-alt me-2"></i> Retry
                                </button>
                            </div>
                        </div>
                        
                        <div class="chart-info mt-4 p-3 bg-light-medium rounded-md">
                            <div class="row g-3">
                                <div class="col-md-3 col-6">
                                    <div class="chart-stat d-flex align-items-center">
                                        <div class="stat-icon me-2 rounded-circle bg-primary bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                            <i class="fas fa-door-open text-primary"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small">Open</div>
                                            <div class="fw-bold" id="chartOpen"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="chart-stat d-flex align-items-center">
                                        <div class="stat-icon me-2 rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                            <i class="fas fa-arrow-up text-success"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small">High</div>
                                            <div class="fw-bold" id="chartHigh"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="chart-stat d-flex align-items-center">
                                        <div class="stat-icon me-2 rounded-circle bg-danger bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                            <i class="fas fa-arrow-down text-danger"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small">Low</div>
                                            <div class="fw-bold" id="chartLow"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6">
                                    <div class="chart-stat d-flex align-items-center">
                                        <div class="stat-icon me-2 rounded-circle bg-info bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                            <i class="fas fa-door-closed text-info"></i>
                                        </div>
                                        <div>
                                            <div class="text-muted small">Close</div>
                                            <div class="fw-bold" id="chartClose"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Company Info -->
        <div class="row justify-content-center mb-5">
            <div class="col-lg-10" data-aos="fade-up" data-aos-delay="250">
                <div class="modern-card border-0 shadow-lg">
                    <div class="card-header bg-gradient-tertiary text-white p-4">
                        <div class="d-flex align-items-center">
                            <div class="company-icon me-3 rounded-circle bg-white p-2 d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                <i class="fas fa-building text-tertiary"></i>
                            </div>
                            <h3 class="mb-0 fw-bold">Company Information</h3>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-6" data-aos="fade-right" data-aos-delay="50">
                                <div class="company-about p-4 rounded-md bg-light-medium h-100">
                                    <div class="d-flex align-items-center mb-3">
                                        <div class="info-icon me-2 rounded-circle bg-primary bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                            <i class="fas fa-info-circle text-primary"></i>
                                        </div>
                                        <h5 class="mb-0 fw-bold">About</h5>
                                    </div>
                                    <p id="companyDescription" class="mb-4"></p>
                                    
                                    <div class="sector-industry mt-4">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="info-icon me-2 rounded-circle bg-info bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                                <i class="fas fa-industry text-info"></i>
                                            </div>
                                            <h5 class="mb-0 fw-bold">Sector & Industry</h5>
                                        </div>
                                        
                                        <div class="sector-badge p-3 mb-3 rounded-md bg-white bg-opacity-75 d-flex align-items-center">
                                            <div class="badge-icon me-2 rounded-circle bg-primary bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <i class="fas fa-chart-pie text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="small text-muted">Sector</div>
                                                <div class="fw-bold fs-5" id="sector"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="industry-badge p-3 rounded-md bg-white bg-opacity-75 d-flex align-items-center">
                                            <div class="badge-icon me-2 rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                <i class="fas fa-sitemap text-success"></i>
                                            </div>
                                            <div>
                                                <div class="small text-muted">Industry</div>
                                                <div class="fw-bold fs-5" id="industry"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6" data-aos="fade-left" data-aos-delay="100">
                                <div class="financials p-4 rounded-md bg-light-medium h-100">
                                    <div class="d-flex align-items-center mb-4">
                                        <div class="info-icon me-2 rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;">
                                            <i class="fas fa-dollar-sign text-success"></i>
                                        </div>
                                        <h5 class="mb-0 fw-bold">Key Financials</h5>
                                    </div>
                                    
                                    <div class="financial-metrics">
                                        <div class="financial-metric p-3 mb-3 rounded-md bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="metric-icon me-2 rounded-circle bg-primary bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-chart-pie text-primary"></i>
                                                </div>
                                                <div class="text-muted">Market Cap</div>
                                            </div>
                                            <div class="fw-bold" id="tableMarketCap"></div>
                                        </div>
                                        
                                        <div class="financial-metric p-3 mb-3 rounded-md bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="metric-icon me-2 rounded-circle bg-info bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-calculator text-info"></i>
                                                </div>
                                                <div class="text-muted">P/E Ratio</div>
                                            </div>
                                            <div class="fw-bold" id="tablePeRatio"></div>
                                        </div>
                                        
                                        <div class="financial-metric p-3 mb-3 rounded-md bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="metric-icon me-2 rounded-circle bg-success bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-coins text-success"></i>
                                                </div>
                                                <div class="text-muted">EPS (TTM)</div>
                                            </div>
                                            <div class="fw-bold" id="tableEps"></div>
                                        </div>
                                        
                                        <div class="financial-metric p-3 mb-3 rounded-md bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="metric-icon me-2 rounded-circle bg-warning bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-book text-warning"></i>
                                                </div>
                                                <div class="text-muted">Price to Book</div>
                                            </div>
                                            <div class="fw-bold" id="priceToBook"></div>
                                        </div>
                                        
                                        <div class="financial-metric p-3 mb-3 rounded-md bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="metric-icon me-2 rounded-circle bg-accent bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-hand-holding-usd text-accent"></i>
                                                </div>
                                                <div class="text-muted">Dividend Yield</div>
                                            </div>
                                            <div class="fw-bold" id="tableDividendYield"></div>
                                        </div>
                                        
                                        <div class="financial-metric p-3 rounded-md bg-white bg-opacity-75 d-flex justify-content-between align-items-center">
                                            <div class="d-flex align-items-center">
                                                <div class="metric-icon me-2 rounded-circle bg-tertiary bg-opacity-10 p-2 d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="fas fa-chart-line text-tertiary"></i>
                                                </div>
                                                <div class="text-muted">Beta</div>
                                            </div>
                                            <div class="fw-bold" id="beta"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Modern Loading Animation */
    .loader-modern {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin: 0 auto;
        width: 80px;
        height: 80px;
    }
    
    .loader-modern.loader-sm {
        width: 60px;
        height: 60px;
        gap: 6px;
    }
    
    .loader-modern div {
        width: 16px;
        height: 16px;
        background: var(--primary-color);
        border-radius: 50%;
        animation: loader-modern 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    }
    
    .loader-modern.loader-sm div {
        width: 12px;
        height: 12px;
    }
    
    .loader-modern div:nth-child(1) {
        animation-delay: 0s;
        background: var(--primary-color);
    }
    
    .loader-modern div:nth-child(2) {
        animation-delay: -0.3s;
        background: var(--secondary-color);
    }
    
    .loader-modern div:nth-child(3) {
        animation-delay: -0.6s;
        background: var(--accent-color);
    }
    
    .loader-modern div:nth-child(4) {
        animation-delay: -0.9s;
        background: var(--tertiary-color);
    }
    
    @keyframes loader-modern {
        0% { transform: scale(0); }
        50% { transform: scale(1); }
        100% { transform: scale(0); }
    }
    
    /* Chart Loading & Error Styles */
    .chart-loading, .chart-error {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        border-radius: 12px;
        z-index: 10;
    }
    
    .dark-mode .chart-loading, .dark-mode .chart-error {
        background-color: rgba(30, 30, 30, 0.9);
    }
    
    /* Stock Stats Animations */
    .stock-stat, .ma-card, .indicator-card, .financial-metric {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stock-stat:hover, .ma-card:hover, .indicator-card:hover, .financial-metric:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    /* Glow effects */
    .indicator-glow, .ma-glow {
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.8) 0%, rgba(255,255,255,0) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
    }
    
    .indicator-card:hover .indicator-glow, .ma-card:hover .ma-glow {
        opacity: 0.3;
        animation: rotate 8s linear infinite;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Search Suggestions Styling */
    .z-index-dropdown {
        z-index: 1000;
    }
    
    /* Search Examples Animation */
    .stock-example {
        transition: all 0.3s ease;
    }
    
    .stock-example:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* Fade-in animation for stock results */
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    /* Pulse animation for search button */
    .btn-pulse {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0.7); }
        70% { box-shadow: 0 0 0 10px rgba(var(--primary-rgb), 0); }
        100% { box-shadow: 0 0 0 0 rgba(var(--primary-rgb), 0); }
    }
    
    /* Shimmer loading effect */
    .shimmer {
        background: linear-gradient(90deg, 
            rgba(255, 255, 255, 0.1) 0%, 
            rgba(255, 255, 255, 0.2) 50%, 
            rgba(255, 255, 255, 0.1) 100%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
    }
    
    /* Progress bar animations */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }
    
    @keyframes progress-bar-stripes {
        0% { background-position-x: 1rem; }
    }
    
    /* Floating animation for cards */
    .float-animation {
        animation: float 6s ease-in-out infinite;
    }
    
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('stockSearchInput');
        const searchButton = document.getElementById('stockSearchButton');
        const searchSuggestions = document.getElementById('searchSuggestions');
        const stockResultsContainer = document.getElementById('stockResultsContainer');
        const stockLoadingOverlay = document.getElementById('stockLoadingOverlay');
        const addToWatchlistBtn = document.getElementById('addToWatchlistBtn');
        const chartContainer = document.getElementById('stockChart');
        
        // Stock chart related elements
        const chartLoading = document.getElementById('chartLoading');
        const chartError = document.getElementById('chartError');
        const retryChartBtn = document.getElementById('retryChartBtn');
        
        // Default chart configuration
        let stockChart = null;
        let currentSymbol = '';
        let currentPeriod = '1mo';
        let chartType = 'line';
        
        // Initialize stock search examples
        document.querySelectorAll('.stock-example').forEach(example => {
            example.addEventListener('click', function(e) {
                e.preventDefault();
                const symbol = this.dataset.symbol;
                searchInput.value = symbol;
                searchStock(symbol);
            });
        });
            
        // Handle search button click
        if (searchButton) {
            searchButton.addEventListener('click', function() {
                const query = searchInput.value.trim();
                if (query.length > 0) {
                    searchStock(query);
                }
            });
        }
        
        // Handle enter key in search input
        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                if (e.key === 'Enter') {
                    const query = this.value.trim();
                    if (query.length > 0) {
                        searchStock(query);
                        }
                    }
            });
            }
            
        // Time period selector
        document.querySelectorAll('[data-period]').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all period buttons
                document.querySelectorAll('[data-period]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Get selected period
                const period = this.dataset.period;
                currentPeriod = period;
                
                // Fetch chart data
                if (currentSymbol) {
                    fetchChartData(currentSymbol, period);
                }
                    });
        });
        
        // Chart type selector
        document.querySelectorAll('[data-chart-type]').forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all chart type buttons
                document.querySelectorAll('[data-chart-type]').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Get selected chart type
                chartType = this.dataset.chartType;
        
                // Update chart if data is already loaded
                if (currentSymbol) {
                    fetchChartData(currentSymbol, currentPeriod);
                }
            });
        });
        
        // Retry chart button
        if (retryChartBtn) {
            retryChartBtn.addEventListener('click', function() {
                if (currentSymbol) {
                    fetchChartData(currentSymbol, currentPeriod);
                }
            });
        }
        
        // Function to search for a stock
        function searchStock(query) {
            // Clear previous results
                searchSuggestions.innerHTML = '';
            
            // Show loading overlay
            stockLoadingOverlay.style.display = 'flex';
            stockResultsContainer.classList.add('d-none');
            
            // Fetch stock data
            fetch(`/api/stock/info?symbol=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Stock not found');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update UI with stock data
                    updateStockInfo(data);
                    
                    // Set current symbol
                    currentSymbol = data.symbol;
                    
                    // Fetch chart data
                    fetchChartData(data.symbol, currentPeriod);
                    
                    // Show results container
                    stockResultsContainer.classList.remove('d-none');
                    
                    // Hide loading overlay
                    stockLoadingOverlay.style.display = 'none';
                })
                .catch(error => {
                    console.error('Error:', error);
                    stockLoadingOverlay.style.display = 'none';
                    showToast('Stock not found or error loading data', 'danger');
                });
        }
        
        // Function to fetch chart data
        function fetchChartData(symbol, period) {
            // Show chart loading
            chartLoading.classList.remove('d-none');
            chartError.classList.add('d-none');
            
            console.log(`Fetching chart data for ${symbol} with period: ${period}`);
            
            // Fetch historical stock data for the chart
            fetch(`/api/stock/data?symbol=${encodeURIComponent(symbol)}&period=${period}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch chart data: ${response.status} ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received chart data:', data);
                    
                    // Log the structure of the data
                    if (data.dates && data.prices) {
                        console.log('Data format: dates + prices arrays');
                        console.log('Sample date:', data.dates[0]);
                        console.log('Sample price:', data.prices[0]);
                    } else if (data.ohlc) {
                        console.log('Data format: ohlc array');
                        console.log('Sample ohlc:', data.ohlc[0]);
                    } else if (Array.isArray(data)) {
                        console.log('Data format: array of objects');
                        console.log('Sample item:', data[0]);
                    } else {
                        console.log('Unknown data format');
                    }
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    // Update chart
                    updateStockChart(data);
                    
                    // Update chart info
                    updateChartInfo(data);
                    
                    // Hide chart loading
                    chartLoading.classList.add('d-none');
                })
                .catch(error => {
                    console.error('Error fetching chart data:', error);
                    chartLoading.classList.add('d-none');
                    chartError.classList.remove('d-none');
                    
                    // Add more descriptive error message to the UI
                    const errorMessage = document.querySelector('#chartError p');
                    if (errorMessage) {
                        errorMessage.textContent = `We couldn't retrieve the historical data for this stock: ${error.message}`;
                    }
                });
                    }
                    
        // Function to update stock info in the UI
        function updateStockInfo(data) {
            // Header info
            document.getElementById('stockName').textContent = data.name || data.symbol;
            document.getElementById('stockSymbol').textContent = data.symbol;
            document.getElementById('stockExchange').textContent = data.exchange || '';
                    
            // Price info
            document.getElementById('stockPrice').textContent = '$' + (data.price || 'N/A');
            
            // Change info
            const changeEl = document.getElementById('stockChange');
            if (data.change !== undefined && data.change_percent !== undefined) {
                const changeClass = data.change >= 0 ? 'text-success' : 'text-danger';
                const changeIcon = data.change >= 0 ? 'fa-caret-up' : 'fa-caret-down';
                changeEl.innerHTML = `
                    <div class="${changeClass}">
                        <i class="fas ${changeIcon}"></i>
                        ${data.change >= 0 ? '+' : ''}${data.change} (${data.change_percent}%)
                    </div>
                        `;
            } else {
                changeEl.textContent = 'N/A';
            }
            
            // Financial metrics
            document.getElementById('marketCap').textContent = data.market_cap || 'N/A';
            document.getElementById('peRatio').textContent = data.pe_ratio || 'N/A';
            document.getElementById('eps').textContent = data.eps || 'N/A';
            document.getElementById('dividendYield').textContent = data.dividend_yield || 'N/A';
            document.getElementById('high52Week').textContent = '$' + (data.fifty_two_week_high || 'N/A');
            document.getElementById('low52Week').textContent = '$' + (data.fifty_two_week_low || 'N/A');
            document.getElementById('volume').textContent = data.volume || 'N/A';
            document.getElementById('avgVolume').textContent = data.avg_volume || 'N/A';
                    
            // Company info
            document.getElementById('companyDescription').textContent = data.description || 'No description available.';
                    document.getElementById('sector').textContent = data.sector || 'N/A';
                    document.getElementById('industry').textContent = data.industry || 'N/A';
                    
            // Links
            if (addToWatchlistBtn) {
                addToWatchlistBtn.dataset.symbol = data.symbol;
                addToWatchlistBtn.dataset.name = data.name || data.symbol;
            }
            
            const analysisLink = document.getElementById('analysisLink');
            if (analysisLink) {
                analysisLink.href = `/stock-analysis/${data.symbol}`;
            }
        }
        
        // Function to update chart info
        function updateChartInfo(data) {
            if (!data) return;
            
            let open, high, low, close;
            
            if (Array.isArray(data) && data.length > 0) {
                // Format for data as array of objects with OHLC properties
                const lastData = data[data.length - 1];
                open = lastData.Open;
                high = lastData.High;
                low = lastData.Low;
                close = lastData.Close;
            } else if (data.ohlc && Array.isArray(data.ohlc) && data.ohlc.length > 0) {
                // Format for data.ohlc
                const lastData = data.ohlc[data.ohlc.length - 1];
                open = lastData.open;
                high = lastData.high;
                low = lastData.low;
                close = lastData.close;
            } else if (data.dates && data.prices && data.dates.length > 0) {
                // Format for data with separate arrays
                const lastIndex = data.prices.length - 1;
                close = data.prices[lastIndex];
                
                // We might not have OHLC data in this format
                if (data.opens && data.highs && data.lows) {
                    open = data.opens[lastIndex];
                    high = data.highs[lastIndex];
                    low = data.lows[lastIndex];
                } else {
                    // Use the close price as a fallback
                    open = close;
                    high = close;
                    low = close;
                }
            }
            
            document.getElementById('chartOpen').textContent = open ? '$' + open.toFixed(2) : 'N/A';
            document.getElementById('chartHigh').textContent = high ? '$' + high.toFixed(2) : 'N/A';
            document.getElementById('chartLow').textContent = low ? '$' + low.toFixed(2) : 'N/A';
            document.getElementById('chartClose').textContent = close ? '$' + close.toFixed(2) : 'N/A';
        }
        
        // Function to update the stock chart
        function updateStockChart(data) {
            if (!data || data.error) {
                chartError.classList.remove('d-none');
                        return;
                    }
                    
            // Extract chart data
            let labels, prices, opens, highs, lows;
                        
            // Check if data is in the expected format
            if (Array.isArray(data)) {
                // Format for data as array of objects with OHLC properties
                if (data.length === 0) {
                    chartError.classList.remove('d-none');
                    return;
                }
                labels = data.map(item => moment(item.Date));
                prices = data.map(item => item.Close);
                opens = data.map(item => item.Open);
                highs = data.map(item => item.High);
                lows = data.map(item => item.Low);
            } else if (data.ohlc && Array.isArray(data.ohlc)) {
                // Format for data.ohlc
                if (data.ohlc.length === 0) {
                    chartError.classList.remove('d-none');
                    return;
        }
                labels = data.ohlc.map(item => moment(item.date));
                prices = data.ohlc.map(item => item.close);
                opens = data.ohlc.map(item => item.open);
                highs = data.ohlc.map(item => item.high);
                lows = data.ohlc.map(item => item.low);
            } else if (data.dates && data.prices) {
                // Format for data with separate arrays
                if (data.dates.length === 0) {
                    chartError.classList.remove('d-none');
                    return;
                }
                labels = data.dates.map(date => moment(date));
                prices = data.prices;
                
                // We don't have OHLC data in this format, so default to using price for candlestick
                opens = prices.slice();
                highs = prices.slice();
                lows = prices.slice();
            } else {
                console.error('Unsupported data format', data);
                chartError.classList.remove('d-none');
                return;
            }
            
            // Destroy existing chart if it exists
            if (stockChart) {
                stockChart.destroy();
            }
            
            // Create new chart
            const ctx = chartContainer.getContext('2d');
            
            if (chartType === 'line') {
                // Line chart
                stockChart = new Chart(ctx, {
                type: 'line',
                data: {
                        labels: Array.isArray(data.dates) ? data.dates : labels.map(d => d.format('MMM DD')),
                    datasets: [{
                        label: 'Price',
                            data: prices,
                            borderColor: '#4e73df',
                            backgroundColor: 'rgba(78, 115, 223, 0.1)',
                        borderWidth: 2,
                        fill: true,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHitRadius: 10,
                            pointHoverRadius: 5,
                            pointHoverBackgroundColor: '#4e73df',
                            pointHoverBorderColor: '#fff',
                            pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                            legend: {
                                display: false
                            },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                        return `$${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                    borderDash: [2],
                                    color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
            } else {
                // Simplified bar chart for now
                const barData = [];
                const barLabels = [];
                
                // Use only a subset of the data points to avoid overcrowding
                const step = Math.max(1, Math.floor(prices.length / 30));
                
                for (let i = 0; i < prices.length; i += step) {
                    barData.push(prices[i]);
                    if (Array.isArray(data.dates)) {
                        barLabels.push(data.dates[i]);
                    } else if (labels[i] && typeof labels[i].format === 'function') {
                        barLabels.push(labels[i].format('MMM DD'));
                    } else {
                        barLabels.push(`Day ${i+1}`);
            }
                }
                
                stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                        labels: barLabels,
                    datasets: [{
                            label: 'Stock Price',
                            data: barData,
                            backgroundColor: function(context) {
                                // Color bars based on increase/decrease from previous value
                                const index = context.dataIndex;
                                if (index === 0) return 'rgba(40, 167, 69, 0.8)';
                                return barData[index] >= barData[index-1] ? 
                                    'rgba(40, 167, 69, 0.8)' : 'rgba(220, 53, 69, 0.8)';
                            },
                            borderColor: 'rgba(0, 0, 0, 0.1)',
                            borderWidth: 1,
                            barPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                            legend: {
                                display: false
                            },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                        return `Price: $${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            grid: {
                                    borderDash: [2],
                                    color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                        return '$' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        }
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0 position-fixed bottom-0 end-0 m-3`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            const bsToast = new bootstrap.Toast(toast, {
                delay: 3000
            });
            
            bsToast.show();
        
            // Remove from DOM after hidden
            toast.addEventListener('hidden.bs.toast', function() {
                document.body.removeChild(toast);
        });
        }
        
        // Add to watchlist button
        if (addToWatchlistBtn) {
        addToWatchlistBtn.addEventListener('click', function() {
                const symbol = this.dataset.symbol;
                const name = this.dataset.name;
            
                if (!symbol) return;
            
            fetch('/api/watchlist/add', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                        symbol: symbol,
                        name: name
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                        showToast(`${symbol} added to watchlist`, 'success');
                        
                        // Update button
                        this.innerHTML = '<i class="fas fa-check me-2"></i> Added to Watchlist';
                        this.classList.remove('btn-modern-primary');
                        this.classList.add('btn-success');
                        this.disabled = true;
                    } else {
                        showToast(data.message || 'Failed to add to watchlist', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error adding to watchlist', 'danger');
            });
        });
        }
    });
</script>
{% endblock %}
